---
description: منطق عمل المساعد الذكي والمسارات والاشتراكات
---

هذا الورك فلو يشرح كيفية عمل نظام المساعد الذكي والمسارات التعليمية (Tracks) وارتباطها بنظام الاشتراكات.

### 1. بوابة الدخول والتحقق من الاشتراك (Subscription Guard)
- **صفحة المساعد الذكي (`/ai-agent`)**:
  - يتم التحقق من حالة `isSubscribed` للمستخدم.
  - إذا لم يكن مشتركاً، تظهر واجهة "Paywall" تحتوي على معلومات الاشتراك وزر يوجه لصفحة الأسعار (`/ai-pricing`).
- **صفحة المسارات (`/tracks`)**:
  - يتم التحقق من حالة الاشتراك؛ إذا كان المستخدم غير مشترك، يتم تحويله تلقائياً (Redirect) إلى صفحة الاشتراك.
- **شريط التنقل (Navbar)**:
  - رابط "المسارات" (Roadmap) مخفي تماماً للمستخدمين غير المشتركين لتبسيط الواجهة.

### 2. تدفق عمل المساعد الذكي (AI Onboarding Flow)
بمجرد الاشتراك، يمكن للمستخدم بدء محادثة مع "المساعد الذكي":
1. **الأسئلة التفاعلية**: يبدأ المساعد الذكي بطرح مجموعة من الأسئلة (20 سؤالاً) تغطي الأهداف، الخبرة، الوقت المتاح، وأسلوب التعلم.
2. **جمع البيانات**: تُخزن الإجابات في ملف تعريف المستخدم (`userProfile`).

### 3. توليد الخطة الدراسية (Plan Generation)
عند اكتمال الأسئلة، يتم استدعاء API الخلفية (`/api/ai-engine/generate-plan`):
- **قاعدة البيانات كمرجع**: يتم جلب جميع الكورسات المنشورة من قاعدة البيانات، مع التركيز على حقل `aiDescription` لكل كورس (التحليل الذكي للكورس).
- **الذكاء الاصطناعي (OpenAI)**: يتم إرسال بيانات المستخدم مع قائمة الكورسات المتاحة إلى موديل **GPT-4o**.
- **منطق الاختيار**: يقوم المساعد الذكي برسم "خارطة طريق" (Roadmap) تبدأ من الصفر حتى الاحتراف (Zero to Hero) باستخدام الكورسات المتوفرة حصراً في المنصة.

### 4. عرض المسارات (Tracks View)
- بعد التوليد، يتم حفظ الخطة في جداول `studyPlans` و `aiSessions`.
- تظهر الخطة فوراً للمستخدم في واجهة المساعد، كما تتوفر دائماً في صفحة "المسارات" (`/tracks`) للمراجعة في أي وقت.

### 5. النقاط التقنية الهامة
- **الربط**: النظام مشبوك مباشرة بـ OpenAI API.
- **التحديث**: في صفحة المسارات، يمكن للمستخدم إعادة التحليل مع المساعد الذكي لتوليد مسار جديد إذا تغيرت أهدافه.
- **التنبيهات**: في حال نقص رصيد OpenAI، يظهر تنبيه للمسؤول لشحن الرصيد.
